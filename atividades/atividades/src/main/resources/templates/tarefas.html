<!DOCTYPE html>
<html>
    <head>
        <title>Tarefas</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link th:href="@{/css/myStyle.css}" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <style>
            #btnTar {
                background-color: green;
                margin-left: 0.5vh;
                zoom: 110%;
                border-top-left-radius: 2vh;
                border-bottom-left-radius: 2vh;
            }
            .hidden {
                display: none;
            }
            .hiddenOff{
                display: flex;
            }
        </style>
    </head>
    <body>
        <header>
            <img th:src="@{/imagens/Logo.png}" width="120vh"/>
        </header>
        <nav>
            <ul class="itens-menu">
                <li class="item-menu" id="btnTar"><a href="/Tarefas">
                        <span class="icon"><i class="bi bi-house-door-fill"></i></span>
                        <span class="txtLink">Tarefas</span>
                    </a></li>
                <li class="item-menu" id="btnHis"><a href="/Historico">
                        <span class="icon"><i class="bi bi-clock-history"></i></span>
                        <span class="txtLink">Historico</span>
                    </a></li>
            </ul>
        </nav>
        <main>
            <div class="divMenu">
                <h3 class="ShowUserID" id="ShowUserID">...</h3>
                <p>Tarefas:</p>
                <div id="btnFunctions">
                    <button style="font-size: 3vh" id="EditTar">Editar Tarefa</button>
                    <button style="font-size: 3vh" id="NewTar">Criar nova Tarefa</button>
                    <button style="font-size: 3vh" id="FinishTar">Finalizar Tarefa</button>
                </div>
                <p id="tarSelect" class="hidden">Clique em uma tarefa da tabela para selecioná-la</p>
                <div class="fncEdit hidden" style="justify-content: center;">
                    <form id="form-editar" style="display: flex; flex-direction: row">
                        <div style="display: flex; flex-direction: column">
                            <input type="hidden" id="txtIdE" name="id"/>
                            <label for="titulo">Título:</label>
                            <input type="text" name="titulo" id="tituloE" required style="font-size: 3vh"/>
                            <label for="descricao">Descrição:</label>
                            <textarea name="descricao" id="descricaoE" required style="font-size: 3vh"></textarea>    
                        </div>
                        <div class="EspaçadorIvh"></div>
                        <div style="display: flex; flex-direction: column">
                            <label for="datat">Data Final:</label>
                            <input type="date" name="datat" id="datatE" required style="font-size: 3vh"/>
                            <label for="statust">Status:</label>
                            <input type="hidden" name="statust" id="txtStatusE"/>
                            <button type="submit" style="font-size: 3vh">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
                <div class="fncAdd hidden" style="justify-content: center;">
                    <form action="/AddTar" method="post" style="display: flex; flex-direction: row">
                        <div style="display: flex; flex-direction: column">
                            <label for="titulo">Título:</label>
                            <input type="text" name="titulo" id="tituloA" required style="font-size: 3vh"/>
                            <label for="descricao">Descrição:</label>
                            <textarea name="descricao" id="descricaoA" required style="font-size: 3vh"></textarea>    
                        </div>
                        <div class="EspaçadorIvh"></div>
                        <div style="display: flex; flex-direction: column">
                            <label for="datat">Data Final:</label>
                            <input type="datetime-local" name="datat" id="datatA" required style="font-size: 3vh"/>
                            <label for="statust">Status:</label>
                            <input type="hidden" name="statust" id="txtStatusA"/>
                            <button type="submit" style="font-size: 3vh">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
                <div class="fncEnd hidden"><button type="submit" id="btnFinalizar" style="font-size: 3vh">Finalizar!</button></div>
            </div>
            <div class="divMenu">
                <div class="table-container">
                    <table id="tblTarefas">
                        <thead>
                            <tr>
                                <th class="hidden-column">ID</th>
                                <th class="hidden-column">ID Usuario</th>
                                <th>Título</th>
                                <th>Descrição</th>
                                <th>Data Final</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="movieRow" th:each="tarefa : ${listarTarefas}">
                                <td class="hidden-column" th:text="${tarefa.id}"></td>
                                <td class="hidden-column" th:text="${tarefa.userId}"></td>
                                <td th:text="${tarefa.titulo}"></td>
                                <td th:text="${tarefa.descricao}"></td>
                                <td class="DataEdit" th:text="${tarefa.datat}"></td>
                                <td th:text="${tarefa.statust}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        <footer>Todos direitos reservados a Diogo Borchhardt Beloni</footer>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const rows = document.querySelectorAll(".movieRow");
                const tarSelect = document.querySelector("#tarSelect");
                const userIdShow = document.querySelector("#ShowUserID");
                const btnEdit = document.querySelector("#EditTar");
                const btnNew = document.querySelector("#NewTar");
                const btnFinish = document.querySelector("#FinishTar");
                const editForm = document.querySelector(".fncEdit");
                const addForm = document.querySelector(".fncAdd");
                const endForm = document.querySelector(".fncEnd");

                userIdShow.textContent = "...";

                let editOn = false;
                let endOn = false;

                let userId;

                async function fetchUserId() {
                    try {
                        const response = await fetch("http://localhost:8080/getUserId", {
                            method: "GET",
                            credentials: "include"
                        });

                        if (response.ok) {
                            userId = await response.text();
                            userIdShow.textContent = "O id do usuario logado é: " + userId;
                            alert("O id do usuario logado é: " + userId);
                        } else {
                            console.log("Falha ao obter o User ID.");
                        }
                    } catch (error) {
                        console.error("Erro:", error);
                    }
                }
                
                fetchUserId();

                function formatarData(dataISO) {
                    const dataObj = new Date(dataISO);

                    const dia = String(dataObj.getDate()).padStart(2, '0');
                    const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
                    const ano = dataObj.getFullYear();
                    const horas = String(dataObj.getHours()).padStart(2, '0');
                    const minutos = String(dataObj.getMinutes()).padStart(2, '0');

                    return `${dia}/${mes}/${ano} Hr${horas}:${minutos}`;
                }

                document.querySelectorAll(".DataEdit").forEach(cell => {
                    const dataISO = cell.textContent.trim();
                    cell.textContent = formatarData(dataISO);

                });

                function showForm(form) {
                    editForm.classList.add("hidden");
                    addForm.classList.add("hidden");
                    endForm.classList.add("hidden");
                    editForm.classList.remove("hiddenOff");
                    addForm.classList.remove("hiddenOff");
                    endForm.classList.remove("hiddenOff");

                    form.classList.remove("hidden");
                    form.classList.add("hiddenOff");
                }

                function clearSelections() {
                    tarSelect.classList.add("hidden");
                    tarSelect.textContent = "Clique em uma tarefa da tabela para selecioná-la";
                    editOn = false;
                    endOn = false;
                }

                // Função para alternar as ações nos rows da tabela com base no contexto (editOn, endOn)
                function setupRowClickActions() {
                    rows.forEach(row => {
                        row.addEventListener("click", function () {
                            const id = row.querySelector("td:nth-child(1)").textContent.trim();
                            const titulo = row.querySelector("td:nth-child(3)").textContent.trim();
                            const descricao = row.querySelector("td:nth-child(4)").textContent.trim();
                            const dataFinal = row.querySelector("td:nth-child(5)").textContent.trim();
                            const status = row.querySelector("td:nth-child(6)").textContent.trim();

                            if (editOn) {
                                // Exibe dados no formulário de edição
                                document.querySelector("#txtIdE").value = id;
                                document.querySelector("#tituloE").value = titulo;
                                document.querySelector("#descricaoE").value = descricao;
                                document.querySelector("#datatE").value = dataFinal;
                                document.querySelector("#txtStatusE").value = status;

                                tarSelect.textContent = `ID da tarefa selecionada: ${id}`;
                                showForm(editForm);
                            } else if (endOn) {
                                document.querySelector("#txtIdE").value = id;
                                tarSelect.textContent = `ID da tarefa selecionada: ${id} \nTem certeza que deseja finalizar esta tarefa?`;
                                showForm(endForm);
                            }
                        });
                    });
                }

                // Configura ações dos botões
                btnEdit.addEventListener("click", function () {
                    clearSelections();
                    editOn = true;
                    tarSelect.classList.remove("hidden");
                    setupRowClickActions();
                });

                btnNew.addEventListener("click", function () {
                    clearSelections();
                    document.querySelector("#tituloA").value = "";
                    document.querySelector("#descricaoA").value = "";
                    document.querySelector("#datatA").value = "";
                    document.querySelector("#txtStatusA").value = "ativa";
                    showForm(addForm);
                });

                btnFinish.addEventListener("click", function () {
                    editForm.classList.add("hidden");
                    addForm.classList.add("hidden");
                    editForm.classList.remove("hiddenOff");
                    addForm.classList.remove("hiddenOff");

                    clearSelections();
                    endOn = true;
                    tarSelect.classList.remove("hidden");
                    setupRowClickActions();
                });

                // Envio do formulário de edição
                document.getElementById('form-editar').addEventListener('submit', async function (event) {
                    event.preventDefault();
                    const id = document.getElementById('txtIdE').value;
                    const titulo = document.getElementById('tituloE').value;
                    const descricao = document.getElementById('descricaoE').value;
                    const dataFinal = document.getElementById('datatE').value;
                    const status = document.getElementById('txtStatusE').value;

                    try {
                        const response = await fetch(`/editar/${id}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({id, titulo, descricao, datat: dataFinal, statust: status})
                        });

                        if (response.ok) {
                            alert('Alterações salvas com sucesso!');
                            window.location.reload();
                        } else {
                            alert('Erro ao salvar as alterações.');
                        }
                    } catch (error) {
                        console.error('Erro na requisição:', error);
                        alert('Erro ao processar a solicitação.');
                    }
                });

                // Envio da função de finalização
                document.getElementById("btnFinalizar").addEventListener("click", async function () {
                    const id = document.getElementById('txtIdE').value;
                    try {
                        const response = await fetch(`/endTar/${id}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        });

                        if (response.ok) {
                            alert('Tarefa finalizada com sucesso!');
                            window.location.reload();
                        } else {
                            alert('Erro ao finalizar a tarefa.');
                        }
                    } catch (error) {
                        console.error('Erro na requisição:', error);
                        alert('Erro ao processar a solicitação.');
                    }
                }, {once: true}); // Use { once: true } para evitar múltiplas associações
            });
        </script>
    </body>
</html>
